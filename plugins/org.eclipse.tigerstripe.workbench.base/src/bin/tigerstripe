#!/bin/sh
#*******************************************************************************
#  Copyright (c) 2007 Cisco Systems, Inc.
#  All rights reserved. This program and the accompanying materials
#  are made available under the terms of the Eclipse Public License v1.0
#  which accompanies this distribution, and is available at
#  http://www.eclipse.org/legal/epl-v10.html
# 
#  Contributors:
#     E. Dillon (Cisco Systems, Inc.) - reformat for Code Open-Sourcing
#*******************************************************************************/

FOREHEAD_VERSION=1.0-beta-5

if [ -z "$TIGERSTRIPE_OPTS" ] ; then
  TIGERSTRIPE_OPTS="-Xmx512m"
fi

if [ -f /etc/tigerstriperc ] ; then
  . /etc/tigerstriperc
fi

if [ -f "$HOME/.tigerstriperc" ] ; then
  . "$HOME/.tigerstriperc"
fi

# OS specific support.  $var _must_ be set to either true or false.
cygwin=false;
darwin=false;
case "`uname`" in
  CYGWIN*) cygwin=true ;;
  Darwin*) darwin=true 
           if [ -z "$JAVA_VERSION" ] ; then
             JAVA_VERSION="CurrentJDK"
           else
             echo "Using Java version: $JAVA_VERSION"
           fi
           if [ -z "$JAVA_HOME" ] ; then
             JAVA_HOME=/System/Library/Frameworks/JavaVM.framework/Versions/${JAVA_VERSION}/Home
           fi
           ;;
esac

# try to find TIGERSTRIPE in well known locations
[ -z "$TIGERSTRIPE_HOME" -a -d /opt/tigerstripe ]		&& TIGERSTRIPE_HOME=/opt/tigerstripe
#[ -z "$TIGERSTRIPE_HOME" -a -d "$HOME/tigerstripe" ]	&& TIGERSTRIPE_HOME="$HOME/tigerstripe"

# Otherwise try to determine it from our invocation path
if [ -z "$TIGERSTRIPE_HOME" ] ; then
  ## resolve links - $0 may be a link to tigerstripe's home
  saveddir=`pwd`

  # need this for relative symlinks
  PRG="$0"    
  while [ -h "$PRG" ]; do
      ls=`ls -ld "$PRG"`
      link=`expr "$ls" : '.*-> \(.*\)$'`
      if expr "$link" : '/.*' > /dev/null; then
          PRG="$link"
      else
          PRG="`dirname $PRG`/$link"
      fi
  done
    
  # Make it fully specified
  cd "`dirname \"$PRG\"`/.."
  TIGERSTRIPE_HOME="`pwd -P`"
  
  cd "$saveddir"
fi

# For Cygwin, ensure paths are in UNIX format before anything is touched
if $cygwin ; then
  [ -n "$TIGERSTRIPE_HOME" ] &&
    TIGERSTRIPE_HOME=`cygpath --unix "$TIGERSTRIPE_HOME"`
  [ -n "$TIGERSTRIPE_HOME_LOCAL" ] &&
    TIGERSTRIPE_HOME_LOCAL=`cygpath --unix "$TIGERSTRIPE_HOME_LOCAL"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
  [ -n "$CLASSPATH" ] &&
    CLASSPATH=`cygpath --path --unix "$CLASSPATH"`
fi

if [ -z "$JAVACMD" ] ; then
  if [ -n "$JAVA_HOME"  ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
    else
      JAVACMD="$JAVA_HOME/bin/java"
    fi
  else
    JAVACMD=java
  fi
fi

if [ ! -x "$JAVACMD" ] ; then
  echo "Error: JAVA_HOME is not defined correctly."
  echo "  We cannot execute $JAVACMD"
  exit 1
fi

if [ -z "$JAVA_HOME" ] ; then
  echo "Warning: JAVA_HOME environment variable is not set."
  echo "  If build fails because sun.* classes could not be found"
  echo "  you will need to set the JAVA_HOME environment variable"
  echo "  to the installation directory of java."
fi

CLASSPATH=""
for jar in `ls ${TIGERSTRIPE_HOME}/lib/*.jar`
do
	CLASSPATH=$CLASSPATH:$jar
done

for zip in `ls ${TIGERSTRIPE_HOME}/lib/*.zip`
do
	CLASSPATH=$CLASSPATH:$zip
done

# For Cygwin, switch paths to Windows format before running java
if $cygwin; then
  [ -n "$TIGERSTRIPE_HOME" ] &&
    TIGERSTRIPE_HOME=`cygpath --path --windows "$TIGERSTRIPE_HOME"`
    TIGERSTRIPE_HOME_LOCAL=`cygpath --path --windows "$TIGERSTRIPE_HOME_LOCAL"`
  [ -n "$JAVA_HOME" ] &&
    JAVA_HOME=`cygpath --path --windows "$JAVA_HOME"`
  [ -n "$HOME" ] &&
    HOME=`cygpath --path --windows "$HOME"`
fi

# For Darwin, use classes.jar for TOOLS_JAR
TOOLS_JAR="${JAVA_HOME}/lib/tools.jar"
CLASSPATH=$CLASSPATH:$TOOLS_JAR
if $darwin; then
  TOOLS_JAR="/System/Library/Frameworks/JavaVM.framework/Versions/${JAVA_VERSION}/Classes/classes.jar"
fi

MAIN_CLASS=org.eclipse.tigerstripe.core.cli.App
if [ -n "$TIGERSTRIPE_HOME_LOCAL" ]; then
  TIGERSTRIPE_OPTS="$TIGERSTRIPE_OPTS -Dtigerstripe.home.local=${TIGERSTRIPE_HOME_LOCAL}" 
fi

if $cygwin; then
	CLASSPATH=`cygpath --path --windows "$CLASSPATH"`
fi

"$JAVACMD" \
  $TIGERSTRIPE_OPTS \
  -classpath "${CLASSPATH}" \
  "-Dtools.jar=$TOOLS_JAR" \
  "-Dtigerstripe.home=${TIGERSTRIPE_HOME}" \
  $MAIN_CLASS "$@"

